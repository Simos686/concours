<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Admin - Game-Marcus</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 219, 222, 0.3);
        }
        
        .admin-section h2 {
            color: #00dbde;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00dbde;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .admin-table th {
            background: rgba(0, 219, 222, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="logo-section">
                <span class="logo">üîê</span>
                <h1>Admin <span class="logo-sub">Game-Marcus</span></h1>
            </div>
            <div class="user-section">
                <a href="index.html" style="color: white; text-decoration: none; margin-right: 20px;">
                    <i class="fas fa-home"></i> Retour au site
                </a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-section">
            <h2><i class="fas fa-chart-bar"></i> Dashboard Administrateur</h2>
            <div id="adminLogin" style="display: block;">
                <h3>Connexion Admin</h3>
                <form id="adminLoginForm">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="adminEmail" placeholder="Email admin" required>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="adminPassword" placeholder="Mot de passe admin" required>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </form>
            </div>
            
            <div id="adminContent" style="display: none;">
                <div class="stats-grid" id="adminStatsGrid"></div>
                
                <div style="margin-top: 30px;">
                    <h3><i class="fas fa-gift"></i> Gestion des concours</h3>
                    <button onclick="adminApp.drawAllWinners()" class="btn-primary" style="margin-bottom: 20px;">
                        <i class="fas fa-random"></i> Tirer tous les gagnants
                    </button>
                    <div id="currentContests"></div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3><i class="fas fa-users"></i> Utilisateurs</h3>
                    <div id="usersList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="database.js"></script>
    <script>
        class AdminApp {
            constructor() {
                this.db = new SupabaseDatabase();
                this.init();
            }
            
            init() {
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                document.getElementById('adminLoginForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.loginAdmin();
                });
            }
            
            async loginAdmin() {
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                
                // V√©rification simple (en production, utilisez Supabase Auth)
                if (email === 'admin@gamemarcus.com' && password === 'Admin123!') {
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    this.showNotification('‚úÖ Connexion admin r√©ussie', 'success');
                    await this.loadAdminData();
                } else {
                    this.showNotification('‚ùå Identifiants incorrects', 'error');
                }
            }
            
            async loadAdminData() {
                await this.loadStats();
                await this.loadContests();
                await this.loadUsers();
            }
            
            async loadStats() {
                const stats = await this.db.getStatistics();
                if (stats.success) {
                    const html = `
                        <div class="stat-box">
                            <span class="stat-value">${stats.data.totalUsers}</span>
                            <span class="stat-label">Utilisateurs</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">${stats.data.totalContests}</span>
                            <span class="stat-label">Concours</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">${stats.data.totalWinners}</span>
                            <span class="stat-label">Gagnants</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">${stats.data.totalTickets}</span>
                            <span class="stat-label">Tickets totaux</span>
                        </div>
                    `;
                    document.getElementById('adminStatsGrid').innerHTML = html;
                }
            }
            
            async loadContests() {
                const contests = await this.db.getContests();
                if (contests.success) {
                    let html = '<table class="admin-table"><thead><tr><th>Nom</th><th>Participants</th><th>Tickets requis</th><th>Statut</th><th>Action</th></tr></thead><tbody>';
                    
                    contests.data.forEach(contest => {
                        html += `
                            <tr>
                                <td>${contest.name}</td>
                                <td>${contest.participants}</td>
                                <td>${contest.tickets_required}</td>
                                <td>${contest.status}</td>
                                <td>
                                    <button onclick="adminApp.drawWinner('${contest.id}')" 
                                            class="btn-secondary"
                                            ${contest.status === 'ended' ? 'disabled' : ''}>
                                        Tirer gagnant
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('currentContests').innerHTML = html;
                }
            }
            
            async drawWinner(contestId) {
                if (!confirm('Tirer un gagnant pour ce concours ?')) return;
                
                const result = await this.db.drawWinner(contestId);
                if (result.success) {
                    this.showNotification(`üéâ ${result.winner.username} a gagn√© ${result.winner.prize} !`, 'success');
                    await this.loadAdminData();
                } else {
                    this.showNotification(`‚ùå ${result.error}`, 'error');
                }
            }
            
            async drawAllWinners() {
                if (!confirm('Tirer les gagnants pour tous les concours actifs ?')) return;
                
                const contests = await this.db.getContests();
                if (contests.success) {
                    for (const contest of contests.data) {
                        if (contest.status === 'active') {
                            await this.drawWinner(contest.id);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
            }
            
            async loadUsers() {
                const users = await this.db.getAllUsers();
                if (users.success) {
                    let html = '<table class="admin-table"><thead><tr><th>Pseudo</th><th>Email</th><th>Tickets</th><th>Inscription</th></tr></thead><tbody>';
                    
                    users.data.forEach(user => {
                        html += `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.tickets}</td>
                                <td>${new Date(user.created_at).toLocaleDateString('fr-FR')}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('usersList').innerHTML = html;
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = message;
                    notification.style.display = 'block';
                    notification.style.background = type === 'success' 
                        ? 'linear-gradient(135deg, #00b09b, #96c93d)' 
                        : 'linear-gradient(135deg, #ff416c, #ff4b2b)';
                    
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        const adminApp = new AdminApp();
        window.adminApp = adminApp;
    </script>
</body>
</html>